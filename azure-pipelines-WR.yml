# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  branches:
    include:
      - refs/heads/snake_case

  paths:
    include:
      - Application
      - bcd-e2e-tests
    exclude:
      - Documents
      - Tests
      - '*.yml'

parameters:
  - name: Environment
    type: string
    default: dev_WR
    values:
      - dev_WR
      - dev
      - dev2
      - docomoIDF
      - prodstg
      - prod
      - demo
      - test
      - BuildandTest

  - name: isManualOperation_prodstgOpt
    type: boolean
    default: false
    values:
      - false
      - true

variables:
  - group: ${{ parameters.Environment }}
  - name: devDeploy #開発環境デプロイフラグ
    value: ${{ or(eq(parameters.Environment,'dev'), eq(parameters.Environment,'dev2'), eq(parameters.Environment,'docomoIDF'), eq(parameters.Environment,'dev_WR'))}}
  - name: Deploy #prod, proddtg, demo環境デプロイフラグ
    value: ${{ or(eq(parameters.Environment,'prodstg'), eq(parameters.Environment,'prod'),eq(parameters.Environment,'demo'),eq(parameters.Environment,'test'))}}
  - name: japanwest #西日本デプロイフラグ
    value:  ${{ or(eq(parameters.Environment,'prod'),eq(parameters.Environment,'prodstg'),eq(parameters.Environment,'test')) }}
  - name: vmPipeline #パイプライン起動停止フラグ
    value:  ${{ or(eq(parameters.Environment,'prod'),eq(parameters.Environment,'prodstg'),eq(parameters.Environment,'test')) }}
  - name: ManualOperation #正常性確認実施フラグ
    value:  ${{ or(eq(parameters.Environment,'prod'),eq(parameters.isManualOperation_prodstgOpt,true)) }}

stages:
- stage: npm_settingStage
  jobs:
  - job: npm_settingJob
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'
      
- stage: chromeStage
  jobs:
  - job: chrome_scenario001
    steps:
    - script:  |
        npm i
        npm run e2e -- spec/scenario001.js
      workingDirectory: '$(Build.SourcesDirectory)/bcd-e2e-tests'